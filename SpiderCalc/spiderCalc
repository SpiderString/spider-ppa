--Main Method, should be bound to the "Chat" event or the "ChatSendFilter" event and nothing else.

--Configurable Variables
local acceptCommandsFromOthers=false --set to false to ignore commands from other players
local acceptCommandsFromPM=false --set to true to allow private messages triggering the script
local commandPrefix="=" --prefix that should be at the start of the line for a calculator command
local eqColor="&6" --color used for answer output

--Inconfigurable Variables. No Touch.
local args={...}
local equation=args[3]
run("SpiderCalc/spiderLib")

local equation, caller
local commandArgs
local command
local self=getPlayer()["name"]

if args[2]=="Chat" then
  equation, caller=stripUsername(args[3], args[4])
else
  equation=args[3]
  caller=self
end
command, commandArgs=getCommand(commandPrefix, equation)
--no command
if args[2]=="ChatSendFilter" then
  if equation==false or equation==nil then
    return args[3]
  elseif not equation:match("^"..commandPrefix) then
    return args[3]
  end
end

if equation ~= false then
  --check if the help command was run
  if command=="help" and (caller==self or acceptCommandsFromOthers) then
    run("SpiderCalc/helpLib")
    help(caller, command, commandArgs)
    equation=false
  --graph command
  elseif command=="graph" and (caller==self or acceptCommandsFromOthers) then
    run("SpiderCalc/graph")
    graph(command, commandArgs)
    equation=false
  elseif command=="clear" and (caller==self or acceptCommandsFromOthers) then
    hud3D.clearAll()
    SPIDERCALCGRAPHPOINTS={}
    equation=false
  elseif command=="translate" and (caller==self or acceptCommandsFromOthers) then
    run("SpiderCalc/graph")
    translate(unpack(commandArgs))
    equation=false
  end
end
--Begin evalutation
if equation ~= false and equation:match("^"..commandPrefix) and (caller==self or acceptCommandsFromOthers) then
  run("SpiderCalc/calcLib")
  equation=equation:gsub("^"..commandPrefix, "")
  equation=removeSpaces(equation)
  equation=equation:lower()
  local origEquation=equation
  equation=tokenize(equation)
  equation=insertAstericks(equation)
  run("SpiderCalc/shuntYard")
  equation=convertToPostfix(equation)
  run("SpiderCalc/postfixInterpreter")
  equation=evaluate(equation)
  SPIDERCALCLASTANS=equation

  --output
  if caller==self then
    advLog({text="<SpiderCalc>: "..origEquation.."="..equation, color=eqColor, tooltip=equation})
  else
    say("<SpiderCalc>: "..origEquation.."="..equation)
  end
end
